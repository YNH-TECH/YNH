<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>BTC Live — لوحة محمية بكلمة مرور (YNH-tech)</title>
<style>
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--txt:#e6edf3;--muted:#9aa4b2;--brand:#0f6cbd;--up:#16a34a;--dn:#dc2626}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Segoe UI',Tahoma,Arial;margin:0}
header{position:sticky;top:0;z-index:30;background:var(--brand);color:#fff;padding:.6rem .9rem}
header h1{margin:0;font-size:1rem;line-height:1.2}
.small{font-size:.85rem;opacity:.9}
.container{padding:.7rem .9rem 1rem}
.toolbar,.controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0}
.btn,.toggle{background:var(--card);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:.5rem .7rem;font-size:.95rem;cursor:pointer}
.toggle.active{background:#0a5ea8;border-color:#0a5ea8}
.badge{background:#111827;border:1px solid #374151;padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
.banner{background:#1f2937;border:1px solid #374151;border-radius:12px;padding:.6rem .75rem;margin:.5rem 0;font-size:.95rem;display:none}
.banner.err{background:#4b1d1d;border-color:#8a2b2b}
.chartWrap{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
svg{display:block;width:100%;height:64vh;max-height:760px}
.grid line{stroke:#2a2f36;stroke-width:1}
.axis{fill:var(--muted);font-size:10px}
.legend{fill:var(--muted);font-size:12px}
.hint{color:var(--muted);font-size:.85rem;margin-top:.4rem}
/* Gate */
.gate{position:fixed;inset:0;background:linear-gradient(180deg,#0b1220,#0d1117);display:flex;align-items:center;justify-content:center;z-index:9999}
.card{width:min(420px,92%);background:#0f172a;border:1px solid #243045;border-radius:14px;padding:18px}
.card h2{margin:.2rem 0 1rem;font-size:1.05rem;color:#e5e7eb}
.row{display:flex;gap:.5rem}
.inp{flex:1;background:#0b1220;border:1px solid #334155;border-radius:10px;padding:.6rem .7rem;color:#e5e7eb;font-size:1rem}
.btnPrimary{background:#0f6cbd;border:1px solid #0f6cbd;color:#fff;border-radius:10px;padding:.6rem .9rem;font-size:1rem;cursor:pointer}
.msg{margin-top:.5rem;color:#fca5a5;font-size:.9rem;min-height:1.2em}
.smallNote{margin-top:.4rem;color:#9aa4b2;font-size:.85rem}
.price{font-weight:600}
</style>
</head>
<body>
<noscript><div style="padding:10px;background:#7f1d1d;color:#fff">⚠️ المتصفح يمنع تشغيل JavaScript. فعّل JavaScript ثم أعد فتح الصفحة.</div></noscript>

<!-- Password Gate -->
<div id="gate" class="gate" aria-modal="true" role="dialog">
  <div class="card">
    <h2>🔐 حماية بكلمة مرور</h2>
    <div class="row">
      <input id="pwd" type="password" class="inp" placeholder="أدخل كلمة المرور" autocomplete="current-password" />
      <button id="go" class="btnPrimary">دخول</button>
    </div>
    <label class="smallNote"><input type="checkbox" id="remember" /> تذكّرني على هذا الجهاز</label>
    <div id="msg" class="msg"></div>
    <div class="smallNote">يمكنك تغيير كلمة المرور عبر تعديل الهاش في الكود (<code>PWD_HASH_HEX</code>).</div>
  </div>
</div>

<!-- محتوى الصفحة المحمي -->
<div id="app" style="display:none">
  <header>
    <h1>BTC Live — محمي (آخر تحديث: 2025-10-04 20:36)</h1>
    <div class="small">هذا العرض يجلب شموع 15م من Coinbase، ويحدّث السعر الحي من Binance WS. ⚠️ للاستخدام التحليلي فقط.</div>
  </header>
  <div class="container">
    <div id="err" class="banner err"></div>

    <div class="toolbar">
      <button id="btnNew" class="btn">🔄 تحديث الآن</button>
      <button id="btnLive" class="toggle">تحديث تلقائي</button>
      <span class="badge">سعر حي: <span id="livePrice" class="price">—</span></span>
      <span style="flex:1"></span>
      <button id="btnLogout" class="btn">🔒 قفل الصفحة</button>
    </div>

    <div class="controls">
      <span class="badge">إظهار/إخفاء:</span>
      <button class="toggle active" data-layer="EMA20">EMA20</button>
      <button class="toggle active" data-layer="EMA50">EMA50</button>
    </div>

    <div class="chartWrap">
      <svg id="svg"></svg>
    </div>

    <div class="hint">إن فشل الجلب الحي: جرّب بعد دقيقة. بإمكانك استخدام التحديث اليدوي. إذا لم تظهر نافذة كلمة المرور، فقد تكون مفعلة "تذكّرني"—اضغط "قفل الصفحة" لمسحها.</div>
  </div>
</div>

<script>
// ===== Password Gate =====
const PWD_HASH_HEX = '764504fa44f41d534b37ebab459a25170472779bd5cc2095101f98087c084356'; // SHA-256 of: default password
const GATE_KEY = 'ynh_gate_ok';
async function sha256(txt){ const enc=new TextEncoder().encode(txt); const h=await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join(''); }
async function checkPwd(){ const pwd=document.getElementById('pwd').value; const remember=document.getElementById('remember').checked; const msg=document.getElementById('msg'); msg.textContent=''; try{ const h=await sha256(pwd); if(h===PWD_HASH_HEX){ (remember?localStorage:sessionStorage).setItem(GATE_KEY,'1'); openApp(); } else { msg.textContent='❌ كلمة مرور غير صحيحة'; } }catch(e){ msg.textContent='حدث خطأ في التحقق'; } }
function openApp(){ document.getElementById('gate').style.display='none'; document.getElementById('app').style.display='block'; startApp(); }
(function(){ const ok = localStorage.getItem(GATE_KEY) || sessionStorage.getItem(GATE_KEY); if(ok==='1'){ openApp(); }})();
document.getElementById('go').addEventListener('click', checkPwd);
document.getElementById('pwd').addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkPwd(); });

// ===== BTC Live Chart (SVG) =====
const svg = document.getElementById('svg');
let DATA=[]; let autoTimer=null; let ws=null;
function showErr(msg){ const e=document.getElementById('err'); e.textContent=msg; e.style.display='block'; }
function hideErr(){ const e=document.getElementById('err'); e.style.display='none'; }

async function fetchCoinbase(){ const url='https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=900'; try{ const rsp=await fetch(url,{headers:{'CB-VERSION':'2015-07-22'}}); if(!rsp.ok) throw new Error('HTTP '+rsp.status); const arr=await rsp.json(); const out=arr.map(d=>({time:new Date(d[0]*1000), low:+d[1], high:+d[2], open:+d[3], close:+d[4]})).sort((a,b)=>a.time-b.time); return out.slice(-200); }catch(e){ showErr('فشل جلب الشموع: '+e.message); return null; } }
function ema(series,span){ const k=2/(span+1); let out=[],prev=null; for(let i=0;i<series.length;i++){ const v=series[i]; prev=(prev==null)?v:(v*k+prev*(1-k)); out.push(prev);} return out; }
function draw(){ svg.innerHTML=''; hideErr(); const W=svg.clientWidth||svg.parentNode.clientWidth||360, H=svg.clientHeight||520; const m={l:56,r:20,t:16,b:22}; const iw=Math.max(200,W-m.l-m.r), ih=Math.max(200,H-m.t-m.b); if(!DATA||DATA.length<2){ showErr('لا توجد بيانات كافية للرسم.'); return; } const xVals=DATA.map(d=>d.time.getTime()); const yHigh=Math.max(...DATA.map(d=>d.high)), yLow=Math.min(...DATA.map(d=>d.low)); const pad=(yHigh-yLow)*0.05, Ymax=yHigh+pad, Ymin=yLow-pad; const x0=xVals[0], x1=xVals[xVals.length-1]; const sx=t=> m.l+((t-x0)/(x1-x0))*iw, sy=v=> m.t+(1-(v-Ymin)/(Ymax-Ymin))*ih; const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('class','grid'); svg.appendChild(g); const ticks=6; for(let i=0;i<=ticks;i++){ const v=Ymin+i*(Ymax-Ymin)/ticks, y=sy(v); const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',m.l); ln.setAttribute('x2',m.l+iw); ln.setAttribute('y1',y); ln.setAttribute('y2',y); ln.setAttribute('stroke','#2a2f36'); g.appendChild(ln); const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',m.l-6); tx.setAttribute('y',y+3); tx.setAttribute('class','axis'); tx.setAttribute('text-anchor','end'); tx.textContent=v.toFixed(0); svg.appendChild(tx);} const n=DATA.length, cw=Math.max(3, iw/n*0.7); for(const d of DATA){ const x=sx(d.time.getTime()); const wick=document.createElementNS('http://www.w3.org/2000/svg','line'); wick.setAttribute('x1',x); wick.setAttribute('x2',x); wick.setAttribute('y1',sy(d.low)); wick.setAttribute('y2',sy(d.high)); wick.setAttribute('stroke','#9aa4b2'); wick.setAttribute('stroke-width','1'); svg.appendChild(wick); const up=d.close>=d.open, color= up? 'var(--up)':'var(--dn)'; const y0=sy(d.open), y1=sy(d.close), h=Math.max(1,Math.abs(y1-y0)); const body=document.createElementNS('http://www.w3.org/2000/svg','rect'); body.setAttribute('x',x-cw/2); body.setAttribute('y',Math.min(y0,y1)); body.setAttribute('width',cw); body.setAttribute('height',h); body.setAttribute('fill',color); svg.appendChild(body);} const closes=DATA.map(d=>d.close), e20=ema(closes,20), e50=ema(closes,50); const p20=pathFromSeries(DATA.map(d=>d.time.getTime()), e20, sx, sy), p50=pathFromSeries(DATA.map(d=>d.time.getTime()), e50, sx, sy); const path20=document.createElementNS('http://www.w3.org/2000/svg','path'); path20.setAttribute('d',p20); path20.setAttribute('stroke','#F59E0B'); path20.setAttribute('fill','none'); path20.setAttribute('stroke-width','1.6'); path20.setAttribute('id','EMA20'); svg.appendChild(path20); const path50=document.createElementNS('http://www.w3.org/2000/svg','path'); path50.setAttribute('d',p50); path50.setAttribute('stroke','#3B82F6'); path50.setAttribute('fill','none'); path50.setAttribute('stroke-width','1.6'); path50.setAttribute('id','EMA50'); svg.appendChild(path50); const lg=document.createElementNS('http://www.w3.org/2000/svg','text'); lg.setAttribute('x', m.l+8); lg.setAttribute('y', m.t+14); lg.setAttribute('class','legend'); lg.textContent='Candles | EMA20 | EMA50'; svg.appendChild(lg); }
function pathFromSeries(xs,ys,sx,sy){ let d='',started=false; for(let i=0;i<xs.length;i++){ if(ys[i]==null||isNaN(ys[i])) continue; const X=sx(xs[i]), Y=sy(ys[i]); d+=(started?' L ':' M ')+X+' '+Y; started=true;} return d; }

async function refreshCandles(){ const d = await fetchCoinbase(); if(d&&d.length){ DATA=d; draw(); } }
function startAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer = setInterval(refreshCandles, 120000); }
function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=null; }

function startWS(){ try{ ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker'); ws.onmessage=(ev)=>{ const o=JSON.parse(ev.data); if(o&&o.c){ document.getElementById('livePrice').textContent = 'BTC '+parseFloat(o.c).toLocaleString('en-US',{maximumFractionDigits:2}); } }; ws.onclose=()=>{ setTimeout(startWS, 5000); }; }catch(e){ /* ignore */ } }
function stopWS(){ try{ if(ws){ ws.close(); ws=null; } }catch(e){}
}

function startApp(){
  // bind
  document.getElementById('btnNew').addEventListener('click', refreshCandles);
  const tg = document.getElementById('btnLive');
  tg.addEventListener('click', ()=>{ tg.classList.toggle('active'); if(tg.classList.contains('active')) startAuto(); else stopAuto(); });
  document.querySelectorAll('.toggle[data-layer]').forEach(btn=>{ btn.addEventListener('click', ()=>{ btn.classList.toggle('active'); const id=btn.getAttribute('data-layer'); const node=document.getElementById(id); if(node) node.style.display = btn.classList.contains('active')? 'inline' : 'none'; }); });
  document.getElementById('btnLogout').addEventListener('click', ()=>{ localStorage.removeItem(GATE_KEY); sessionStorage.removeItem(GATE_KEY); location.reload(); });
  // first load
  refreshCandles();
  startWS();
}
</script>
</body>
</html>