<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1'/>
<title>XAU — إشعارات فورية بدون شموع (PAXGUSDT/BNB WS)</title>
<style>
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--txt:#e6edf3;--muted:#9aa4b2;--brand:#0f6cbd;--up:#16a34a;--dn:#ef4444}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:'Segoe UI',Tahoma,Arial;margin:0}
header{position:sticky;top:0;z-index:10;background:var(--brand);color:#fff;padding:.7rem .9rem}
header h1{margin:0;font-size:1rem}
.small{font-size:.85rem;opacity:.92}
.container{padding:1rem .9rem 2rem;display:grid;gap:.9rem}
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.9rem}
.row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.badge{background:#111827;border:1px solid #374151;padding:.35rem .55rem;border-radius:999px;font-size:.85rem}
.btn,.toggle{background:var(--card);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:.55rem .7rem;font-size:.95rem;cursor:pointer}
.toggle.active{background:#0a5ea8;border-color:#0a5ea8}
.price{font-weight:700;font-size:1.35rem}
.kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.5rem;margin-top:.5rem}
.kv div{background:#0f172a;border:1px solid #243045;border-radius:8px;padding:.5rem .6rem;font-size:.95rem}
.kv b{display:block;color:#9ca3af;font-weight:600;margin-bottom:.2rem}
.sig{border-left:4px solid #10b981;padding-left:.6rem}
.sig.sell{border-color:#ef4444}
.list{display:grid;gap:.5rem}
.input{flex:1;min-width:260px;background:#0b1220;border:1px solid #334155;border-radius:10px;padding:.55rem .7rem;color:#e5e7eb}
.err{background:#4b1d1d;border:1px solid #8a2b2b;border-radius:10px;padding:.5rem .7rem;display:none}
</style>
</head>
<body>
<header>
  <h1>XAU — إشعارات فورية بدون رسم شموع (آخر تحديث: 2025-10-06 13:26)</h1>
  <div class='small'>المصدر: <b>Binance WebSocket</b> لسعر PAXGUSDT + Kline 1m/15m لإشارات RSI/EMA/MACD. لا حاجة لـ REST، لتفادي مشاكل CORS.</div>
</header>
<div class='container'>

  <div id='err' class='err'></div>

  <section class='panel'>
    <div class='row'>
      <span class='badge'>رمز: PAXGUSDT ≈ XAUUSD</span>
      <span class='badge'>فاصل الإشارات: 15m</span>
      <span class='badge'>حجم نافذة 15m: 200</span>
      <span class='badge'>سعر حي: <span id='live' class='price'>—</span></span>
      <span style='flex:1'></span>
      <button id='start' class='toggle'>بدء الإشارات</button>
      <button id='notify' class='toggle'>تفعيل إشعارات المتصفح</button>
    </div>
    <div class='row' style='margin-top:.6rem'>
      <input id='webhook' class='input' placeholder='اختياري: Webhook لرسائل البريد/الموبايل (IFTTT/Power Automate)'/>
      <button id='save' class='btn'>حفظ</button>
      <button id='test' class='btn'>اختبار إرسال</button>
    </div>
  </section>

  <section class='panel'>
    <div class='row'><b>مؤشرات 15m (مباشر):</b></div>
    <div class='kv'>
      <div><b>EMA20</b><span id='ema20'>—</span></div>
      <div><b>EMA50</b><span id='ema50'>—</span></div>
      <div><b>RSI(14)</b><span id='rsi'>—</span></div>
      <div><b>MACD(12,26,9)</b><span id='macd'>—</span></div>
    </div>
  </section>

  <section class='panel'>
    <div class='row'><b>آخر الإشارات:</b></div>
    <div id='signals' class='list'></div>
  </section>

</div>

<script>
// ===== Utilities =====
const $=s=>document.querySelector(s);
let allowNotify=false, ws=null, ws2=null, running=false;
const state={{ price:null, k1m:{{}}, k15m:{{}}, buf15:[], ema20:null, ema50:null, rsi:null, macd:null }};
let lastMacdHist=null, lastSignalTs=0;

function showErr(msg){{ const e=$('#err'); e.textContent=msg; e.style.display='block'; }}
function hideErr(){{ const e=$('#err'); e.style.display='none'; }}

function ema(arr, span){{ const k=2/(span+1); let out=[], prev=null; for(let i=0;i<arr.length;i++){{ const v=arr[i]; prev=(prev==null)?v:(v*k+prev*(1-k)); out.push(prev);}} return out; }}
function rsi(arr, p=14){{ let g=[],l=[],o=new Array(arr.length).fill(null); for(let i=1;i<arr.length;i++){{ const ch=arr[i]-arr[i-1]; g.push(Math.max(ch,0)); l.push(Math.max(-ch,0)); if(i>=p){{ const G=g.slice(i-p,i).reduce((a,b)=>a+b,0)/p; const L=l.slice(i-p,i).reduce((a,b)=>a+b,0)/p; const rs=(L===0)?100:(G/L); o[i]=100-(100/(1+rs)); }} }} return o; }}
function macd(arr, f=12,s=26,sg=9){{ const ef=ema(arr,f), es=ema(arr,s); const m=ef.map((v,i)=>v-es[i]); const sgm=ema(m,sg); const h=m.map((v,i)=>v-sgm[i]); return {{m, s:sgm, h}}; }}

function fmt(x, d=2){{ return (x==null||isNaN(x))?'—':(+x).toFixed(d); }}
function pushSignal(sig){{ const box=$('#signals'); const el=document.createElement('div'); el.className='sig '+(sig.type==='SELL'?'sell':''); el.innerHTML = `
  <div><b>TYPE:</b> $TYPE | <b>السعر:</b> $PRICE | <b>RSI:</b> $RSI | <b>MACD H:</b> $HIST</div>
  <div style='font-size:.9rem;color:#9aa4b2'>$TIME — شرط: $REASON</div>`
  .replace('$TYPE', sig.type)
  .replace('$PRICE', fmt(sig.price))
  .replace('$RSI', fmt(sig.rsi,0))
  .replace('$HIST', fmt(sig.hist,3))
  .replace('$TIME', new Date(sig.ts).toLocaleString())
  .replace('$REASON', sig.reason);
  box.prepend(el);
}}

async function sendWebhook(payload){{ try{{ const url=localStorage.getItem('xau_webhook'); if(!url) return; await fetch(url,{{method:'POST', headers:{{'Content-Type':'application/json'}}, body:JSON.stringify(payload)}}); }}catch(e){{ /* ignore */ }} }}

function notify(sig){{ if(allowNotify && Notification.permission==='granted'){{ new Notification(`XAU: ${{sig.type}} @ ${{fmt(sig.price)}}`, {{ body: sig.reason }}); }} }}

function updateUI(){{ $('#live').textContent = state.price? Number(state.price).toLocaleString('en-US',{{maximumFractionDigits:2}}) : '—';
  const closes = state.buf15.map(b=>b.c);
  const e20 = ema(closes,20), e50 = ema(closes,50); state.ema20=e20.at(-1); state.ema50=e50.at(-1);
  const r = rsi(closes,14); state.rsi=r.at(-1);
  const M = macd(closes); const hist=M.h.at(-1); state.macd={{m:M.m.at(-1), s:M.s.at(-1), h:hist}};
  $('#ema20').textContent = fmt(state.ema20);
  $('#ema50').textContent = fmt(state.ema50);
  $('#rsi').textContent   = fmt(state.rsi,0);
  $('#macd').textContent  = `MACD ${{fmt(M.m.at(-1),3)}} | Sig ${{fmt(M.s.at(-1),3)}} | Hist ${{fmt(hist,3)}}`;
}}

function maybeSignal(){{ if(state.buf15.length<60) return; const now=Date.now(); if(now - lastSignalTs < 60000) return; // 1m throttle
  const closes = state.buf15.map(b=>b.c);
  const e20 = ema(closes,20).at(-1), e50 = ema(closes,50).at(-1);
  const r = rsi(closes,14).at(-1);
  const M = macd(closes); const hist = M.h.at(-1), prevHist = M.h.at(-2);
  if(hist==null || prevHist==null || r==null) return;
  let sig=null;
  if(e20>e50 && prevHist<=0 && hist>0 && r>=50 && r<=70){{ sig={{type:'BUY', price:state.price, rsi:r, hist:hist, ts:now, reason:'تقاطع MACD صعودي + EMA20>EMA50 + RSI[50..70]'}}; }}
  else if(e20<e50 && prevHist>=0 && hist<0 && r>=30 && r<=50){{ sig={{type:'SELL', price:state.price, rsi:r, hist:hist, ts:now, reason:'تقاطع MACD هبوطي + EMA20<EMA50 + RSI[30..50]'}}; }}
  if(sig){{ lastSignalTs=now; pushSignal(sig); notify(sig); sendWebhook({{symbol:'XAU (PAXGUSDT)', ...sig}}); }}
}}

function onKline15(ev){{ try{{ const o = JSON.parse(ev.data); const d = o.data || o; if(!d.k) return; const k=d.k; if(k.s!=='PAXGUSDT' || k.i!=='15m') return; // build buffer of closed klines
  const item={{t:k.t, o:+k.o, h:+k.h, l:+k.l, c:+k.c, x:k.x}};
  const idx = state.buf15.findIndex(b=>b.t===item.t);
  if(idx>=0) state.buf15[idx]=item; else state.buf15.push(item);
  if(state.buf15.length>200) state.buf15 = state.buf15.slice(-200);
  updateUI(); if(k.x && running) maybeSignal();
 }}catch(e){{ /* ignore */ }} }}

function onTicker(ev){{ try{{ const o = JSON.parse(ev.data); const d = o.data || o; if(d.c){{ state.price = d.c; updateUI(); }} }}catch(e){{}} }}

function start(){{ if(ws||ws2) return; hideErr(); running=true;
  try{{
    ws  = new WebSocket('wss://stream.binance.com:9443/stream?streams=paxgusdt@kline_15m');
    ws.onmessage = onKline15; ws.onclose=()=>{{ ws=null; if(running) setTimeout(start, 1500); }};
    ws.onerror = ()=>{{ showErr('تعذر الاتصال بقناة Kline 15m. سيعاد المحاولة.'); }};
    ws2 = new WebSocket('wss://stream.binance.com:9443/ws/paxgusdt@ticker');
    ws2.onmessage = onTicker; ws2.onclose=()=>{{ ws2=null; if(running) setTimeout(start, 1500); }};
  }}catch(e){{ showErr('WebSocket فشل: '+e.message); }}
}}
function stop(){{ running=false; if(ws){{ try{{ ws.close(); }}catch(_ ){{}} ws=null; }} if(ws2){{ try{{ ws2.close(); }}catch(_ ){{}} ws2=null; }} }}

$('#start').addEventListener('click',()=>{{ const b=$('#start'); b.classList.toggle('active'); if(b.classList.contains('active')){{ b.textContent='إيقاف الإشارات'; start(); }} else {{ b.textContent='بدء الإشارات'; stop(); }}});
$('#notify').addEventListener('click', async ()=>{{ try{{ const p=await Notification.requestPermission(); allowNotify = (p==='granted'); $('#notify').classList.toggle('active', allowNotify); if(allowNotify) new Notification('تم تفعيل الإشعارات المباشرة'); }}catch(e){{}} }});
$('#save').addEventListener('click',()=>{{ const url=$('#webhook').value.trim(); if(url){{ localStorage.setItem('xau_webhook', url); alert('تم الحفظ'); }} }});
$('#test').addEventListener('click',()=>{{ const url=localStorage.getItem('xau_webhook'); if(!url) return alert('أضف رابط Webhook أولاً'); sendWebhook({{test:true, msg:'Ping from XAU signal page', t:Date.now()}}); alert('تم إرسال اختبار'); }});

(()=>{{ const u=localStorage.getItem('xau_webhook'); if(u) $('#webhook').value=u; }})();
</script>
</body>
</html>